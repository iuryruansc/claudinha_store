<%- include('../../partials/header.ejs') %>
    <%- include('../../partials/navbar.ejs') %>

        <body>
            <main id="appMain" class="main-content">
                <div class="container">
                    <h2 class="mb-4">
                        <i class="bi bi-bar-chart-line"></i> Resumo de Operações
                    </h2>
                    <div id="error-popup-container"></div>
                    <div class="row g-4">
                        <!-- NOVO CAIXA -->
                        <div class="col-md-4">
                            <div class="card bg-light h-100 shadow">
                                <div class="card-body">

                                    <% if (!caixa) { %>
                                        <!-- Sem caixa ativo: formulário de abertura -->
                                        <h5 class="card-title btn-checkout-text">
                                            <i class="bi-cash-stack me-2"></i>Abrir Caixa
                                        </h5>
                                        <p class="card-text">Selecione o PDV e informe o saldo inicial.</p>
                                        <form action="/admin/caixa/abrir" method="POST"
                                            class="d-flex flex-column gap-2">
                                            <select name="id_pdv" class="form-select form-select-sm" required>
                                                <option value="" disabled selected>Escolha o PDV</option>
                                                <% pdvs.forEach(pdv=> { %>
                                                    <option value="<%= pdv.id_pdv %>">
                                                        <%= pdv.descricao %>
                                                    </option>
                                                    <% }) %>
                                            </select>
                                            <input type="number" step="0.01" name="saldo_inicial"
                                                class="form-control form-control-sm" placeholder="Saldo inicial"
                                                required />
                                            <button type="submit" class="btn btn-checkout text-white btn-sm">
                                                Abrir Caixa
                                            </button>
                                        </form>

                                        <% } else { %>
                                            <!-- Caixa ativo: formulário de fechamento -->
                                            <h5 class="card-title darker-red-text">
                                                <i class="bi-lock-fill me-2"></i>Fechar Caixa
                                            </h5>
                                            <p class="card-text">
                                                Caixa aberto em <%= formatDate(caixa.data_abertura || caixa.createdAt)
                                                    %>
                                                    (Saldo inicial: R$ <%= parseFloat(caixa.saldo_inicial).toFixed(2) %>
                                                        )
                                            </p>
                                            <form action="/admin/caixa/fechar" method="POST"
                                                class="d-flex flex-column gap-2">
                                                <input type="number" step="0.01" name="saldo_final"
                                                    class="form-control form-control-sm" placeholder="Saldo final"
                                                    required />
                                                <button type="submit" class="btn btn-danger btn-sm">
                                                    Fechar Caixa
                                                </button>
                                            </form>
                                            <% } %>

                                </div>
                            </div>
                        </div>

                        <!-- NOVO LOTE -->
                        <div class="col-md-4">
                            <div class="card bg-light h-100 shadow">
                                <div class="card-body">

                                    <h5 class="card-title btn-checkout-text">
                                        <i class="bi bi-box-arrow-in-down me-2"></i>Entrada de Produto
                                    </h5>
                                    <p class="card-text">
                                        Escaneie ou digite o código de barras para iniciar a entrada.
                                    </p>

                                    <form id="formIniciarEntrada">
                                        <div class="mb-3">
                                            <input type="text" name="codigo_barras" id="cardCodigoBarra"
                                                class="form-control form-control-sm" placeholder="Código de Barras"
                                                autocomplete="off" required>
                                        </div>

                                        <button type="button" id="btnIniciarEntrada"
                                            class="btn btn-checkout text-white btn-sm w-100">
                                            Iniciar Entrada
                                        </button>
                                    </form>

                                </div>
                            </div>
                        </div>

                        <!-- NOVA PROMOÇÃO -->
                        <div class="col-md-4">
                            <div class="card bg-light h-100 shadow">
                                <div class="card-body">
                                    <h5 class="card-title text-success">
                                        <i class="bi bi-tag-fill me-2"></i>Cadastrar Promoção
                                    </h5>
                                    <p class="card-text">
                                        Escaneie ou digite o código de barras do produto.
                                    </p>
                                    <form id="formIniciarPromocao">
                                        <div class="mb-3">
                                            <input type="text" name="codigo_barras_promo" id="promocaoCodigoBarra"
                                                class="form-control form-control-sm" placeholder="Código de Barras"
                                                autocomplete="off" required />
                                        </div>
                                        <button type="button" id="btnIniciarPromocao"
                                            class="btn bg-success text-white btn-sm w-100">
                                            Cadastrar Promoção
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="container mt-5">
                    <div class="row">
                        <!-- ACTIVITY FEED-->
                        <div class="col-lg-6 mb-4">
                            <div class="card shadow">
                                <div class="card-header softer-blue text-white">
                                    <i class="bi bi-activity me-2"></i>Feed de Atividade Recente
                                </div>
                                <div class="card-body">
                                    <ul class="list-group list-group-flush">
                                        <% atividades.forEach(atividade=> { %>
                                            <li class="list-group-item">
                                                <i class="bi <%= atividade.tipo === 'entrada' ? 'bi-box-arrow-in-down' :
                                                    atividade.tipo === 'saida' ? 'bi-box-arrow-up' :
                                                    atividade.tipo === 'venda' ? 'bi-cart-check' :
                                                    'bi-info-circle' %> 
                                                    me-2 text-primary">
                                                </i>

                                                <% if (atividade.tipo==='entrada' ) { %>
                                                    <strong>Entrada:</strong>
                                                    <%= atividade.quantidade %> unidades do "<%= atividade.produto %>"
                                                            adicionadas
                                                            <% } else if (atividade.tipo==='saida' ) { %>
                                                                <strong>Saída:</strong>
                                                                <%= atividade.quantidade %> unidades do "<%=
                                                                        atividade.produto %>" removidas
                                                                        <% } else if (atividade.tipo==='venda' ) { %>
                                                                            <strong>Nova Venda:</strong> Venda #<%=
                                                                                atividade.venda_id %> realizada
                                                                                <% } else { %>
                                                                                    <strong>Evento:</strong>
                                                                                    <%= atividade.observacao %>
                                                                                        <% } %>
                                                                                            <span class="text-muted">—
                                                                                                <%= atividade.horas_ago
                                                                                                    %> horas
                                                                                                    atrás
                                                                                            </span>
                                            </li>
                                            <% }) %>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- PROMOÇÕES -->
                        <div class="col-lg-6 mb-4">
                            <div class="card shadow">
                                <div class="card-header bg-success text-white">
                                    <i class="bi bi-tag me-2"></i> Produtos em Promoção
                                </div>
                                <div class="row g-4">
                                    <% if (promoList.length) { %>
                                        <% promoList.forEach((promo, idx)=> { %>
                                            <div
                                                class="col-12 col-sm-6 col-lg-4 mb-4 <%= idx % 2 === 0 ? 'promo-odd' : 'promo-even' %>">
                                                <div
                                                    class="promo-card position-relative overflow-hidden h-100 d-flex flex-column shadow-sm">
                                                    <div class="ribbon bg-danger text-white">
                                                        -<%= Math.round(((promo.precoOriginal - promo.precoPromocional)
                                                            / promo.precoOriginal) * 100) %>%
                                                    </div>

                                                    <div class="card-body d-flex flex-column">
                                                        <h5 class="card-title mb-2">
                                                            <%= promo.nome %>
                                                        </h5>

                                                        <div class="mb-3">
                                                            <span class="text-muted text-decoration-line-through me-2">
                                                                R$<%= promo.precoOriginal %>
                                                            </span>
                                                            <span class="h5 text-success mb-0">
                                                                R$<%= promo.precoPromocional %>
                                                            </span>
                                                        </div>

                                                        <div class="progress mb-1">
                                                            <div class="progress-bar promo-bar" role="progressbar"
                                                                data-inicio="<%= promo.dataInicio %>"
                                                                data-fim="<%= promo.dataFim %>"></div>
                                                        </div>
                                                        <div class="promo-remaining text-end small"></div>
                                                    </div>
                                                </div>
                                            </div>
                                            <% }) %>
                                                <% } else { %>
                                                    <p class="text-center">Nenhuma promoção ativa no momento.</p>
                                                    <% } %>
                                </div>

                            </div>
                        </div>

                        <!-- SNAPSHOT ESTOQUE -->
                        <div class="col-lg-6 mb-4">
                            <div class="card shadow">
                                <div class="card-header bg-warning text-dark">
                                    <i class="bi bi-boxes me-2"></i> Visualização Rápida do Estoque
                                </div>
                                <div class="card-body">
                                    <ul class="list-group list-group-flush animate__animated animate__fadeIn">
                                        <% lotesBaixoEstoque.slice(0, 5).forEach(lote=> { %>
                                            <% const produtoNome=lote.produto?.nome || 'Produto desconhecido' ; %>
                                                <% const qtd=lote.quantidade; %>
                                                    <% const validade=formatDate(lote.data_validade); %>
                                                        <% const loteNum=lote.numero_lote; %>

                                                            <% let badgeClass='bg-success' ; %>
                                                                <% let iconClass='bi-check-circle' ; %>
                                                                    <% if (qtd <=5) { badgeClass='bg-danger' ;
                                                                        iconClass='bi-exclamation-triangle' ; } else if
                                                                        (qtd <=8) { badgeClass='bg-warning text-dark' ;
                                                                        iconClass='bi-exclamation-circle' ; } %>

                                                                        <li class="list-group-item d-flex justify-content-between align-items-center"
                                                                            data-bs-toggle="tooltip"
                                                                            data-bs-placement="top"
                                                                            title="Lote #<%= loteNum %> — Válido até <%= validade %>">
                                                                            <div>
                                                                                <i class="bi <%= iconClass %> me-2"></i>
                                                                                <%= produtoNome %>
                                                                            </div>
                                                                            <span
                                                                                class="badge <%= badgeClass %> rounded-pill fw-bold">
                                                                                <%= qtd %> restantes
                                                                            </span>
                                                                        </li>
                                                                        <% }) %>
                                    </ul>

                                    <div class="text-muted small mt-3">
                                        <i class="bi bi-exclamation-triangle text-danger"></i> Estoque crítico |
                                        <i class="bi bi-exclamation-circle text-warning"></i> Estoque baixo |
                                        <i class="bi bi-check-circle text-success"></i> Estoque saudável
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- PAGAMENTOS -->
                        <div class="col-lg-6 mb-4">
                            <div class="card shadow">
                                <div class="card-header bg-danger text-white">
                                    <i class="bi bi-credit-card me-2"></i> Pagamentos Recentes
                                </div>
                                <div class="card-body">
                                    <ul class="list-group list-group-flush">
                                        <!-- SUBSTITUIR POR EJS DINÂMICO DE PAGAMENTOS -->
                                        <li class="list-group-item">
                                            Venda #1023 — <span class="text-success">Completa</span>
                                        </li>
                                        <li class="list-group-item">
                                            Venda #1024 — <span class="text-warning">Pendente</span>
                                        </li>
                                        <li class="list-group-item">
                                            Venda #1025 — <span class="text-success">Completa</span>
                                        </li>
                                        <li class="list-group-item">
                                            Venda #1026 — <span class="text-success">Completa</span>
                                        </li>
                                        <li class="list-group-item">
                                            Venda #1027 — <span class="text-warning">Pendente</span>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
            </main>


            <%- include('../../partials/footer.ejs') %>

                <%- include('../../partials/entrada-produto-modal.ejs') %>
                    <%- include('../../partials/promocao-modal.ejs') %>

                        <script type="module">
                            import { setupMultiFieldNew } from '/js/multi-field-new.js';
                            import { showErrorPopup } from '/js/show-error-popup.js';
                            import { initEntradaProduto } from "/js//entrada-produto.js";

                            document.addEventListener('DOMContentLoaded', function () {
                                const entradaModal = document.getElementById('entradaProdutoModal');
                                const entradaForm = document.getElementById('formEntradaProduto');
                                const promocaoModal = document.getElementById('promocaoModal');
                                const promocaoForm = document.getElementById('formDesconto');

                                // Entrada de Produto
                                initEntradaProduto({
                                    btnSelector: "#btnIniciarEntrada",
                                    inputSelector: "#cardCodigoBarra",
                                    modalSelector: "#entradaProdutoModal",
                                    endpoint: "/admin/dashboard/entrada/iniciar",
                                    onError: showErrorPopup
                                });

                                setupMultiFieldNew({
                                    formSelector: '#formEntradaProduto',
                                    inputFields: [
                                        '#modalProdutoId',
                                        '#numeroLote',
                                        '#produtoPreco',
                                        '#quantidade',
                                        '#dataValidade',
                                        '#localizacao'
                                    ],
                                    selectFields: [],
                                    requiredFields: [
                                        'id_produto',
                                        'numero_lote',
                                        'preco_produto',
                                        'quantidade',
                                        'data_validade',
                                        'localizacao'
                                    ],
                                    redirectUrl: '/admin/dashboard',
                                    fieldMap: {
                                        id_produto: '#modalProdutoId',
                                        preco_produto: '#produtoPreco',
                                        numero_lote: '#numeroLote',
                                        quantidade: '#quantidade',
                                        data_validade: '#dataValidade',
                                        localizacao: '#localizacao'
                                    },
                                    errorMessages: {
                                        network: 'Erro de rede ao criar lote.'
                                    },
                                })

                                entradaModal.addEventListener('hidden.bs.modal', () => {
                                    entradaForm.reset();
                                });

                                // Entrada de Promoção
                                initEntradaProduto({
                                    btnSelector: '#btnIniciarPromocao',
                                    inputSelector: '#promocaoCodigoBarra',
                                    modalSelector: '#promocaoModal',
                                    endpoint: '/admin/dashboard/entrada/iniciar',
                                    onError: showErrorPopup
                                });

                                setupMultiFieldNew({
                                    formSelector: '#formDesconto',
                                    inputFields: [
                                        '#modalDescProdutoId',
                                        '#modalDescValor',
                                        '#modalDescInicio',
                                        '#modalDescFim',
                                        '#modalDescObservacao'
                                    ],
                                    selectFields: [
                                        '#modalDescTipo'
                                    ],
                                    requiredFields: [
                                        'id_produto',
                                        'tipo',
                                        'valor',
                                        'data_inicio',
                                        'data_fim'
                                    ],

                                    redirectUrl: '/admin/dashboard',
                                    fieldMap: {
                                        id_produto: '#modalDescProdutoId',
                                        tipo: '#modalDescTipo',
                                        valor: '#modalDescValor',
                                        data_inicio: '#modalDescInicio',
                                        data_fim: '#modalDescFim',
                                        observacao: '#modalDescObservacao'
                                    },
                                    errorMessages: {
                                        network: 'Erro de rede ao criar desconto.'
                                    }
                                });

                                promocaoModal.addEventListener('hidden.bs.modal', () => {
                                    promocaoForm.reset();
                                })

                                document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => {
                                    new bootstrap.Tooltip(el);
                                });

                            });
                        </script>
        </body>

        </html>