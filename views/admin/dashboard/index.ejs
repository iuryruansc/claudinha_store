<%- include('../../partials/header.ejs') %>
    <%- include('../../partials/navbar.ejs') %>

        <body>
            <main class="main-content">
                <div class="container">
                    <h2 class="mb-4">
                        <i class="bi bi-bar-chart-line"></i> Resumo de Operações
                    </h2>
                    <% if (erro==='caixa' ) { %>
                        <div class="alert alert-warning alert-dismissible fade show" role="alert">
                            <strong>⚠️ Atenção:</strong> Você precisa abrir um caixa antes de acessar Vendas.
                            <button type="button" class="btn-close" data-bs-dismiss="alert"
                                aria-label="Fechar"></button>
                        </div>
                        <% } %>

                            <div class="row g-4">
                                <!-- NOVO CAIXA -->
                                <div class="col-md-4">
                                    <div class="card bg-light h-100 shadow">
                                        <div class="card-body">

                                            <% if (!caixa) { %>
                                                <!-- Sem caixa ativo: formulário de abertura -->
                                                <h5 class="card-title btn-checkout-text">
                                                    <i class="bi-cash-stack me-2"></i>Abrir Caixa
                                                </h5>
                                                <p class="card-text">Selecione o PDV e informe o saldo inicial.</p>
                                                <form action="/admin/caixa/abrir" method="POST"
                                                    class="d-flex flex-column gap-2">
                                                    <select name="id_pdv" class="form-select form-select-sm" required>
                                                        <option value="" disabled selected>Escolha o PDV</option>
                                                        <% pdvs.forEach(pdv=> { %>
                                                            <option value="<%= pdv.id_pdv %>">
                                                                <%= pdv.descricao %>
                                                            </option>
                                                            <% }) %>
                                                    </select>
                                                    <input type="number" step="0.01" name="saldo_inicial"
                                                        class="form-control form-control-sm" placeholder="Saldo inicial"
                                                        required />
                                                    <button type="submit" class="btn btn-checkout text-white btn-sm">
                                                        Abrir Caixa
                                                    </button>
                                                </form>

                                                <% } else { %>
                                                    <!-- Caixa ativo: formulário de fechamento -->
                                                    <h5 class="card-title darker-red-text">
                                                        <i class="bi-lock-fill me-2"></i>Fechar Caixa
                                                    </h5>
                                                    <p class="card-text">
                                                        Caixa aberto em <%= formatDate(caixa.data_abertura ||
                                                            caixa.createdAt) %>
                                                            (Saldo inicial: R$ <%=
                                                                parseFloat(caixa.saldo_inicial).toFixed(2) %>)
                                                    </p>
                                                    <form action="/admin/caixa/fechar" method="POST"
                                                        class="d-flex flex-column gap-2">
                                                        <input type="number" step="0.01" name="saldo_final"
                                                            class="form-control form-control-sm"
                                                            placeholder="Saldo final" required />
                                                        <button type="submit" class="btn btn-danger btn-sm">
                                                            Fechar Caixa
                                                        </button>
                                                    </form>
                                                    <% } %>

                                        </div>
                                    </div>
                                </div>

                                <!-- NOVO LOTE -->
                                <div class="col-md-4">
                                    <div class="card bg-light h-100 shadow">
                                        <div class="card-body">

                                            <h5 class="card-title btn-checkout-text">
                                                <i class="bi bi-box-arrow-in-down me-2"></i>Entrada de Produto
                                            </h5>
                                            <p class="card-text">
                                                Escaneie ou digite o código de barras para iniciar a entrada
                                            </p>

                                            <form id="formIniciarEntrada">
                                                <div class="mb-3">
                                                    <input type="text" name="codigo_barras" id="cardCodigoBarra"
                                                        class="form-control form-control-sm"
                                                        placeholder="Código de Barras" autocomplete="off" required>
                                                </div>

                                                <button type="button" id="btnIniciarEntrada"
                                                    class="btn btn-checkout text-white btn-sm w-100">
                                                    Iniciar Entrada
                                                </button>
                                            </form>

                                        </div>
                                    </div>
                                </div>

                                <!-- ADICIONAR LINK PARA TODOS OS PAGAMENTOS -->
                                <div class="col-md-4">
                                    <div class="card bg-light h-100 shadow">
                                        <div class="card-body">
                                            <h5 class="card-title darker-purple-text">
                                                <i class="bi bi-clock me-2"></i> Pagamentos Pendentes
                                            </h5>
                                            <p class="card-text">Existe(m) venda(s) com pagamentos pendentes.</p>
                                            <button class="btn btn-sm darker-purple text-white">Ver Pagamentos</button>
                                        </div>
                                    </div>
                                </div>

                            </div>
                </div>

                <div class="container mt-5">
                    <div class="row">
                        <div class="col-lg-6 mb-4">
                            <div class="card shadow">
                                <div class="card-header softer-blue text-white">
                                    <i class="bi bi-activity me-2"></i>Feed de Atividade Recente
                                </div>
                                <div class="card-body">
                                    <ul class="list-group list-group-flush">
                                        <% atividades.forEach(atividade=> { %>
                                            <li class="list-group-item">
                                                <i class="bi <%= atividade.tipo === 'entrada' ? 'bi-box-arrow-in-down' :
                                                    atividade.tipo === 'saida' ? 'bi-box-arrow-up' :
                                                    atividade.tipo === 'venda' ? 'bi-cart-check' :
                                                    'bi-info-circle' %> 
                                                    me-2 text-primary">
                                                </i>

                                                <% if (atividade.tipo==='entrada' ) { %>
                                                    <strong>Entrada:</strong>
                                                    <%= atividade.quantidade %> unidades do "<%= atividade.produto %>"
                                                            adicionadas
                                                            <% } else if (atividade.tipo==='saida' ) { %>
                                                                <strong>Saída:</strong>
                                                                <%= atividade.quantidade %> unidades do "<%=
                                                                        atividade.produto %>" removidas
                                                                        <% } else if (atividade.tipo==='venda' ) { %>
                                                                            <strong>Nova Venda:</strong> Venda #<%=
                                                                                atividade.venda_id %> realizada
                                                                                <% } else { %>
                                                                                    <strong>Evento:</strong>
                                                                                    <%= atividade.observacao %>
                                                                                        <% } %>
                                                                                            <span class="text-muted">—
                                                                                                <%= atividade.horas_ago
                                                                                                    %> horas
                                                                                                    atrás
                                                                                            </span>
                                            </li>
                                            <% }) %>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-6 mb-4">
                            <div class="card shadow">
                                <div class="card-header bg-success text-white">
                                    <i class="bi bi-tag me-2"></i> Produtos em Promoção
                                </div>
                                <div class="card-body">
                                    <ul class="list-group list-group-flush">
                                        <!-- Example static items; replace with dynamic EJS later -->
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            Produto D
                                            <span>
                                                <del class="text-muted">R$25.00</del>
                                                <span class="badge bg-light text-success ms-2">R$18.00</span>
                                            </span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            Produto A
                                            <span>
                                                <del class="text-muted">R$60.00</del>
                                                <span class="badge bg-light text-success ms-2">R$45.00</span>
                                            </span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            Produto C
                                            <span>
                                                <del class="text-muted">R$40.00</del>
                                                <span class="badge bg-light text-success ms-2">R$32.00</span>
                                            </span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            Produto F
                                            <span>
                                                <del class="text-muted">R$10.00</del>
                                                <span class="badge bg-light text-success ms-2">R$7.50</span>
                                            </span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            Produto G
                                            <span>
                                                <del class="text-muted">R$15.00</del>
                                                <span class="badge bg-light text-success ms-2">R$11.00</span>
                                            </span>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-6 mb-4">
                            <div class="card shadow">
                                <div class="card-header bg-warning text-dark">
                                    <i class="bi bi-boxes me-2"></i> Visualização Rápida do Estoque
                                </div>
                                <div class="card-body">
                                    <ul class="list-group list-group-flush animate__animated animate__fadeIn">
                                        <% lotesBaixoEstoque.slice(0, 5).forEach(lote=> { %>
                                            <% const produtoNome=lote.produto?.nome || 'Produto desconhecido' ; %>
                                                <% const qtd=lote.quantidade; %>
                                                    <% const validade=formatDate(lote.data_validade); %>
                                                        <% const loteNum=lote.numero_lote; %>

                                                            <% let badgeClass='bg-success' ; %>
                                                                <% let iconClass='bi-check-circle' ; %>
                                                                    <% if (qtd <=5) { badgeClass='bg-danger' ;
                                                                        iconClass='bi-exclamation-triangle' ; } else if
                                                                        (qtd <=8) { badgeClass='bg-warning text-dark' ;
                                                                        iconClass='bi-exclamation-circle' ; } %>

                                                                        <li class="list-group-item d-flex justify-content-between align-items-center"
                                                                            data-bs-toggle="tooltip"
                                                                            data-bs-placement="top"
                                                                            title="Lote #<%= loteNum %> — Válido até <%= validade %>">
                                                                            <div>
                                                                                <i class="bi <%= iconClass %> me-2"></i>
                                                                                <%= produtoNome %>
                                                                            </div>
                                                                            <span
                                                                                class="badge <%= badgeClass %> rounded-pill fw-bold">
                                                                                <%= qtd %> restantes
                                                                            </span>
                                                                        </li>
                                                                        <% }) %>
                                    </ul>

                                    <div class="text-muted small mt-3">
                                        <i class="bi bi-exclamation-triangle text-danger"></i> Estoque crítico |
                                        <i class="bi bi-exclamation-circle text-warning"></i> Estoque baixo |
                                        <i class="bi bi-check-circle text-success"></i> Estoque saudável
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-6 mb-4">
                            <div class="card shadow">
                                <div class="card-header bg-danger text-white">
                                    <i class="bi bi-credit-card me-2"></i> Pagamentos Recentes
                                </div>
                                <div class="card-body">
                                    <ul class="list-group list-group-flush">
                                        <!-- SUBSTITUIR POR EJS DINÂMICO DE PAGAMENTOS -->
                                        <li class="list-group-item">
                                            Venda #1023 — <span class="text-success">Completa</span>
                                        </li>
                                        <li class="list-group-item">
                                            Venda #1024 — <span class="text-warning">Pendente</span>
                                        </li>
                                        <li class="list-group-item">
                                            Venda #1025 — <span class="text-success">Completa</span>
                                        </li>
                                        <li class="list-group-item">
                                            Venda #1026 — <span class="text-success">Completa</span>
                                        </li>
                                        <li class="list-group-item">
                                            Venda #1027 — <span class="text-warning">Pendente</span>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>

            </main>
            <%- include('../../partials/entradaProdutoModal.ejs') %>

                <%- include('../../partials/footer.ejs') %>

                    <script type="module">
                        import { setupMultiFieldNew } from '/js/multi-field-new.js';

                        document.addEventListener('DOMContentLoaded', function () {
                            const btnIniciar = document.getElementById('btnIniciarEntrada');
                            const inputBarcode = document.getElementById('cardCodigoBarra');
                            const bootstrapModal = new bootstrap.Modal(
                                document.getElementById('entradaProdutoModal')
                            );

                            btnIniciar.addEventListener('click', async () => {
                                const codigo = inputBarcode.value.trim();
                                if (!codigo) {
                                    return alert('Informe um código de barras');
                                }

                                try {
                                    const res = await fetch(
                                        `/admin/dashboard/entrada/iniciar?codigo_barras=${encodeURIComponent(codigo)}`
                                    );
                                    if (!res.ok) {
                                        const err = await res.json();
                                        throw new Error(err.error || 'Produto não encontrado');
                                    }

                                    const { id_produto, nome } = await res.json();

                                    document.getElementById('modalProdutoId').value = id_produto;
                                    document.getElementById('modalProdutoNome').value = nome;

                                    inputBarcode.value = '';
                                    bootstrapModal.show();

                                } catch (error) {
                                    alert(error.message);
                                }
                            });

                            setupMultiFieldNew({
                                formSelector: '#formEntradaProduto',
                                inputFields: [
                                    '#numeroLote',
                                    '#quantidade',
                                    '#dataValidade',
                                    '#localizacao'
                                ],
                                selectFields: [],
                                requiredFields: [
                                    'id_produto',
                                    'numero_lote',
                                    'quantidade',
                                    'data_validade',
                                    'localizacao'
                                ],
                                fieldMap: {
                                    id_produto: '#modalProdutoId',
                                    numero_lote: '#numeroLote',
                                    quantidade: '#quantidade',
                                    data_validade: '#dataValidade',
                                    localizacao: '#localizacao'
                                },
                                errorMessages: {
                                    network: 'Erro de rede ao criar lote.'
                                },
                            })

                            document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => {
                                new bootstrap.Tooltip(el);
                            });
                        });
                    </script>
        </body>

        </html>