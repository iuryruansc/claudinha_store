<%- include('../../partials/header.ejs') %>
    <%- include('../../partials/navbar.ejs') %>

        <body>
            <main class="main-content">
                <div class="container">

                    <div class="d-flex justify-content-between align-items-center my-4">
                        <h2 class="mb-0 h4">
                            <i class="bi bi-wallet2 me-2"></i> Histórico de Pagamentos
                        </h2>
                        <form id="periodo-form" method="GET" action="/admin/pagamentos" class="d-flex gap-2 align-items-end">
                            <div class="input-group">
                                <label class="input-group-text" for="ano-select">Ano</label>
                                <select name="ano" id="ano-select" class="form-select">
                                    <% Object.keys(periodosDisponiveis).sort((a, b)=> b - a).forEach(ano => { %>
                                        <option value="<%= ano %>" <%=ano==anoSelecionado ? 'selected' : '' %>>
                                            <%= ano %>
                                        </option>
                                        <% }) %>
                                </select>
                            </div>

                            <div id="mes-select-div" class="input-group">
                                <label class="input-group-text" for="mes-select">Mês</label>
                                <select name="mes" id="mes-select" class="form-select">
                                    <% const mesesDoAnoSelecionado=periodosDisponiveis[anoSelecionado] || []; %>
                                        <% for (let mes=1; mes <=12; mes++) { %>
                                            <% const nomeMes=new Date(anoSelecionado, mes - 1).toLocaleString('pt-BR', {
                                                month: 'long' }); %>
                                                <% const mesCapitalizado=nomeMes.charAt(0).toUpperCase() +
                                                    nomeMes.slice(1); %>
                                                    <% const desabilitado=!mesesDoAnoSelecionado.includes(mes)
                                                        ? 'disabled' : '' ; %>
                                                        <option value="<%= mes %>" <%=mes==mesSelecionado ? 'selected'
                                                            : '' %>
                                                            <%= desabilitado %>>
                                                                <%= mesCapitalizado %>
                                                        </option>
                                                        <% } %>
                                </select>
                            </div>
                        </form>
                    </div>

                    <ul class="nav nav-tabs mb-3">
                        <li class="nav-item">
                            <a class="nav-link active" aria-current="page" href="/admin/pagamentos">
                                <i class="bi bi-clock-history me-1"></i> Histórico Completo
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/admin/pagamentos/contas-a-receber">
                                <i class="bi bi-cash-stack me-1"></i> Contas a Receber
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/admin/pagamentos/parcelas-a-receber">
                                <i class="bi bi-credit-card-2-front me-1"></i> Parcelas a Receber
                            </a>
                        </li>
                    </ul>

                    <div class="card shadow-sm">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table id="table-data" class="table table-striped table-hover align-middle">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Data</th>
                                            <th>Cliente</th>
                                            <th>Referência da Venda</th>
                                            <th>Tipo</th>
                                            <th>Forma</th>
                                            <th>Valor</th>
                                            <th class="text-center">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% historico.forEach(item=> { %>
                                            <tr>
                                                <td class="text-nowrap"
                                                    title="<%= new Date(item.data).toLocaleString('pt-BR') %>">
                                                    <%= new Date(item.data).toLocaleDateString('pt-BR', { day: '2-digit'
                                                        , month: '2-digit' , year: 'numeric' }) %>
                                                </td>
                                                <td>
                                                    <%= item.cliente %>
                                                </td>
                                                <td>
                                                    <div class="fw-semibold">
                                                        <%= item.resumoVenda %>
                                                    </div>
                                                    <small class="text-muted">
                                                        <a href="/admin/vendas/detalhes/<%= item.vendaId %>"
                                                            class="text-decoration-none">
                                                            Ver Venda #<%= item.vendaId %>
                                                        </a>
                                                    </small>
                                                </td>
                                                <td>
                                                    <% if (item.tipo.includes('Integral')) { %>
                                                        <i class="bi bi-check-circle-fill text-success me-1"
                                                            title="Pagamento Integral"></i>
                                                        <% } else if (item.tipo.includes('Parcial')) { %>
                                                            <i class="bi bi-pie-chart-fill text-info me-1"
                                                                title="Pagamento Parcial"></i>
                                                            <% } else if (item.tipo.includes('Parcela')) { %>
                                                                <i class="bi bi-calendar-check text-secondary me-1"
                                                                    title="Pagamento de Parcela"></i>
                                                                <% } %>
                                                                    <%= item.tipo %>
                                                </td>
                                                <td class="text-capitalize">
                                                    <%= item.forma.replace('_', ' ' ) %>
                                                </td>
                                                <td class="text-nowrap">
                                                    <%= parseFloat(item.valor).toLocaleString('pt-BR', {
                                                        style: 'currency' , currency: 'BRL' }) %>
                                                </td>
                                                <td class="text-center">
                                                    <% let statusClass='' ; switch (item.status.toLowerCase()) {
                                                        case 'completo' : case 'pago' : statusClass='bg-success' ;
                                                        break; case 'parcial' : case 'pendente' :
                                                        statusClass='bg-warning text-dark' ; break; case 'atrasado' :
                                                        statusClass='bg-danger' ; break; default:
                                                        statusClass='bg-secondary' ; } %>
                                                        <span class="badge <%= statusClass %> text-capitalize">
                                                            <%= item.status %>
                                                        </span>
                                                </td>
                                            </tr>
                                            <% }) %>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </main>

            <%- include('../../partials/footer.ejs') %>

                <script>
                    const anoSelect = document.getElementById('ano-select');
                    const mesSelect = document.getElementById('mes-select');
                    const form = document.getElementById('periodo-form');

                    anoSelect.addEventListener('change', function () {
                        const mesesDisponiveis = <%- JSON.stringify(periodosDisponiveis) %>;
                        const primeiroMesDisponivel = mesesDisponiveis[this.value] ? mesesDisponiveis[this.value][0] : new Date().getMonth() + 1;
                        mesSelect.value = primeiroMesDisponivel;
                        form.submit();
                    });

                    mesSelect.addEventListener('change', function () {
                        form.submit();
                    });
                </script>

        </body>
        </html>