<div class="table-responsive">
    <table id="table-data" class="table table-striped table-hover align-middle"
        data-table-type="produtos">
        <thead class="table-dark">
            <tr>
                <th class="text-center">Produto</th>
                <th class="text-center">Preço de Compra</th>
                <th class="text-center">Preço de Venda</th>
                <th class="text-center">Quantidade</th>
                <th>Categoria</th>
                <th>Marca</th>
                <th class="text-center">
                    <div class="d-flex align-items-center justify-content-center">
                        <span>Ações</span>
                        <div class="form-check form-switch ms-3">
                            <input aria-checked="false" class="form-check-input"
                                type="checkbox" role="switch" id="toggleExcluir"
                                title="Habilitar exclusão">
                        </div>
                    </div>
                </th>
            </tr>
        </thead>

        <tbody id="produtos-table-body">
            <% (produtos || []).forEach(produto=> {
                const fornecedor = (fornecedores || []).find(f =>
                String(f.id_fornecedor) === String(produto.id_fornecedor));
                const marca = (marcas || []).find(m => String(m.id_marca) ===
                String(produto.id_marca));
                %>
                <tr data-produto-id="<%= produto.id_produto %>">
                    <td
                        data-search="<%= (produto.nome + ' ' + (produto.codigo_barras || '')).trim() %>">
                        <strong>
                            <%= produto.nome %>
                        </strong>
                    </td>
                    <td class="text-center">
                        <%= produto.preco_compra !=null ?
                            produto.preco_compra.toLocaleString('pt-BR', {
                            style: 'currency' , currency: 'BRL' }) : '-' %>
                    </td>
                    <td class="text-center">
                        <%= produto.preco_venda !=null ?
                            produto.preco_venda.toLocaleString('pt-BR', {
                            style: 'currency' , currency: 'BRL' }) : '-' %>
                    </td>
                    <td class="text-center">
                        <%= produto.quantidade_estoque ?? '-' %>
                    </td>
                    <td>
                        <a class="badge text-bg-secondary text-decoration-none">
                            <%= (categorias || []).find(c=> String(c.id_categoria)
                                === String(produto.id_categoria))?.nome || '-' %>
                        </a>
                    </td>
                    <td>
                        <a class="badge text-bg-light text-decoration-none">
                            <%= marca ? marca.nome_marca : '-' %>
                        </a>
                    </td>

                    <td class="text-center">
                        <fieldset class="btn-group">
                            <a href="/admin/produtos/edit/<%= produto.id_produto %>"
                                class="btn btn-sm btn-outline-primary"
                                title="Editar produto"><i
                                    class="bi bi-pencil-square"></i></a>

                            <a href="#"
                                class="btn btn-sm btn-outline-secondary me-1 details-btn"
                                data-produto-id="<%= produto.id_produto %>"
                                title="Ver detalhes">
                                <i class="bi bi-info-circle"></i>
                            </a>

                            <form data-delete-form
                                action="/admin/produtos/delete/<%= produto.id_produto %>"
                                method="POST" class="d-inline">
                                <input type="hidden" name="id_produto"
                                    value="<%= produto.id_produto %>">
                                <button
                                    class="btn btn-sm btn-outline-danger excluir-btn"
                                    title="Excluir produto" style="display: none;">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </form>
                        </fieldset>
                    </td>
                </tr>
                <% }) %>
        </tbody>
    </table>
</div>

<% const currentPage=page || 1; %>
<% const totalItems=total || (produtos ? produtos.length : 0); %>
<% const totalPages=Math.max(1, Math.ceil(totalItems / (perPage || 25))); %>

<nav aria-label="Paginação produtos" class="mt-3">
    <ul class="pagination justify-content-center mb-0">
        <% const buildUrl=(p)=> {
            const params = new URLSearchParams();
            params.set('page', p);
            params.set('perPage', perPage || 25);
            if (typeof querySearch !== 'undefined' && querySearch)
            params.set('search', querySearch);
            if (typeof queryCategoria !== 'undefined' && queryCategoria)
            params.set('id_categoria', queryCategoria);
            if (typeof queryFornecedor !== 'undefined' && queryFornecedor)
            params.set('id_fornecedor', queryFornecedor);
            if (typeof queryMarca !== 'undefined' && queryMarca)
            params.set('id_marca', queryMarca);
            if (typeof queryOrder !== 'undefined' && queryOrder)
            params.set('order', queryOrder);
            return '/admin/produtos?' + params.toString();
            };
            %>

        <li class="page-item <%= currentPage === 1 ? 'disabled' : '' %>">
            <a class="page-link" href="<%= buildUrl(1) %>">Primeiro</a>
        </li>
        <li
            class="page-item <%= currentPage === 1 ? 'disabled' : '' %>">
            <a class="page-link"
                href="<%= buildUrl(Math.max(1, currentPage - 1)) %>">Anterior</a>
        </li>

        <% const start=Math.max(1, currentPage - 2); %>
        <% const end=Math.min(totalPages, currentPage + 2); %>
        <% for (let p=start; p <=end; p++) { %>
            <li
                class="page-item <%= p === currentPage ? 'active' : '' %>">
                <a class="page-link" href="<%= buildUrl(p) %>">
                    <%= p %>
                </a>
            </li>
            <% } %>

        <li
            class="page-item <%= currentPage === totalPages ? 'disabled' : '' %>">
            <a class="page-link"
                href="<%= buildUrl(Math.min(totalPages, currentPage + 1)) %>">Próximo</a>
        </li>

        <li
            class="page-item <%= currentPage === totalPages ? 'disabled' : '' %>">
            <a class="page-link"
                href="<%= buildUrl(totalPages) %>">Último</a>
        </li>
    </ul>

    <div class="text-center mt-2 small text-muted">
        Mostrando página <strong>
            <%= currentPage %>
        </strong> de <strong>
            <%= totalPages %>
        </strong> — Total de registros: <strong>
            <%= totalItems %>
        </strong>
    </div>
</nav>