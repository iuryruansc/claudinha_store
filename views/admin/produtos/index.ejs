<%- include('../../partials/header.ejs') %>
    <%- include('../../partials/navbar.ejs') %>

        <body>
            <main class="main-content">
                <div class="container">
                    <div id="error-popup-container"></div>

                    <div class="d-flex justify-content-between align-items-center my-4">
                        <h2 class="mb-0 h4">
                            <i class="bi bi-box-seam me-2"></i>
                            Gerenciamento de Produtos
                        </h2>
                        <a href="/admin/produtos/new" class="btn btn-primary">
                            <i class="bi bi-plus-circle me-2"></i>Novo Produto
                        </a>
                    </div>

                    <div class="card shadow-sm mb-3">
                        <div class="card-body">
                            <form id="produtos-filters-form" class="row g-2 align-items-center mb-3" method="get"
                                action="/admin/produtos">
                                <input type="hidden" name="page" value="1">
                                <div class="col-auto">
                                    <input id="search-input" name="search"
                                        value="<%= typeof querySearch !== 'undefined' ? querySearch : '' %>"
                                        class="form-control form-control-sm" placeholder="Buscar por nome ou cÃ³digo">
                                </div>

                                <div class="col-auto">
                                    <select name="id_categoria" class="form-select form-select-sm">
                                        <option value="">Todas Categorias</option>
                                        <% (categorias || []).forEach(c=> { %>
                                            <option value="<%= c.id_categoria %>"
                                                <%=(String(c.id_categoria)===String(typeof queryCategoria !=='undefined'
                                                ? queryCategoria : '' ) ? 'selected' : '' ) %>><%= c.nome %>
                                            </option>
                                            <% }) %>
                                    </select>
                                </div>

                                <div class="col-auto">
                                    <select name="id_fornecedor" class="form-select form-select-sm">
                                        <option value="">Todos Fornecedores</option>
                                        <% (fornecedores || []).forEach(f=> { %>
                                            <option value="<%= f.id_fornecedor %>"
                                                <%=(String(f.id_fornecedor)===String(typeof queryFornecedor
                                                !=='undefined' ? queryFornecedor : '' ) ? 'selected' : '' ) %>><%=
                                                    f.nome_fornecedor %>
                                            </option>
                                            <% }) %>
                                    </select>
                                </div>

                                <div class="col-auto">
                                    <select name="id_marca" class="form-select form-select-sm">
                                        <option value="">Todas Marcas</option>
                                        <% (marcas || []).forEach(m=> { %>
                                            <option value="<%= m.id_marca %>" <%=(String(m.id_marca)===String(typeof
                                                queryMarca !=='undefined' ? queryMarca : '' ) ? 'selected' : '' ) %>><%=
                                                    m.nome_marca %>
                                            </option>
                                            <% }) %>
                                    </select>
                                </div>

                                <div class="col-auto">
                                    <select id="perPageSelect" name="perPage" class="form-select form-select-sm">
                                        <% const perPageVal=perPage || 25; %>
                                            <option value="10" <%=perPageVal==10 ? 'selected' : '' %>>10</option>
                                            <option value="25" <%=perPageVal==25 ? 'selected' : '' %>>25</option>
                                            <option value="50" <%=perPageVal==50 ? 'selected' : '' %>>50</option>
                                            <option value="100" <%=perPageVal==100 ? 'selected' : '' %>>100</option>
                                    </select>
                                </div>

                                <div class="col-auto">
                                    <button type="submit" class="btn btn-sm btn-outline-primary">Aplicar</button>
                                </div>
                            </form>

                            <div id="produtos-table-wrapper">
                                <%- include('./_produtos-table.ejs') %>
                            </div>
                        </div>
                    </div>
                </div>
            </main>

            <%- include('../../partials/modals/produto-details-modal.ejs') %>
                <%- include('../../partials/footer-produtos.ejs') %>

                    <script type="module">
                        import { setupRowDelete } from '/js/lib/delete-handler.js';

                        document.addEventListener('DOMContentLoaded', function () {
                            const toggleExcluir = document.getElementById('toggleExcluir');
                            const searchInput = document.getElementById('search-input');
                            const produtosTableWrapper = document.getElementById('produtos-table-wrapper');
                            const filterForm = document.getElementById('produtos-filters-form');

                            const modalEl = document.getElementById('produtoDetailsModal');
                            const bsModal = new bootstrap.Modal(modalEl);
                            const loadingEl = document.getElementById('produto-details-loading');
                            const contentEl = document.getElementById('produto-details-content');

                            async function fetchProdutoDetails(id) {
                                const url = `/admin/produtos/${id}/json`;
                                const resp = await fetch(url, { headers: { 'Accept': 'application/json' } });
                                if (!resp.ok) throw new Error('Falha ao buscar detalhes do produto');
                                return await resp.json();
                            }

                            function formatCurrency(value) {
                                return value == null ? '-' : Number(value).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                            }

                            async function openProdutoModal(id) {
                                loadingEl.classList.remove('d-none');
                                loadingEl.textContent = 'Carregando...';
                                contentEl.classList.add('d-none');
                                bsModal.show();

                                try {
                                    const data = await fetchProdutoDetails(id);
                                    document.getElementById('pd-nome').textContent = data.nome || '-';
                                    document.getElementById('pd-codigo').textContent = data.codigo_barras || '-';
                                    document.getElementById('pd-preco-compra').textContent = formatCurrency(data.preco_compra);
                                    document.getElementById('pd-preco-venda').textContent = formatCurrency(data.preco_venda);
                                    document.getElementById('pd-quantidade').textContent = data.quantidade_estoque ?? '-';
                                    document.getElementById('pd-fornecedor').textContent = data.nome_fornecedor || '-';
                                    document.getElementById('pd-marca').textContent = data.nome_marca || '-';

                                    loadingEl.classList.add('d-none');
                                    contentEl.classList.remove('d-none');
                                } catch (err) {
                                    loadingEl.textContent = 'Erro ao carregar detalhes';
                                    console.error(err);
                                }
                            }

                            function rebindTableEvents(container) {
                                const tooltipTriggerList = container.querySelectorAll('[title]');
                                [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));

                                container.querySelectorAll('.details-btn').forEach(btn => {
                                    btn.addEventListener('click', (e) => {
                                        e.preventDefault();
                                        const id = btn.dataset.produtoId;
                                        if (!id) return;
                                        openProdutoModal(id);
                                    });
                                });

                                const newDeleteForms = container.querySelectorAll('[data-delete-form]');
                                const newTableBody = container.querySelector('#produtos-table-body');
                                const newToggleExcluir = container.querySelector('#toggleExcluir');

                                const toggle = newToggleExcluir || toggleExcluir;
                                if (newTableBody) {
                                    setupRowDelete(newDeleteForms, toggle, newTableBody);
                                }
                            }

                            async function updateTable(url) {
                                const urlWithAjax = new URL(url, window.location.origin);
                                urlWithAjax.searchParams.set('ajax', '1');

                                try {
                                    const resp = await fetch(urlWithAjax.toString(), {
                                        headers: {
                                            'X-Requested-With': 'XMLHttpRequest',
                                            'Accept': 'text/html'
                                        }
                                    });
                                    if (!resp.ok) throw new Error('Falha ao carregar dados da tabela');

                                    const html = await resp.text();
                                    produtosTableWrapper.innerHTML = html;
                                    rebindTableEvents(produtosTableWrapper);
                                } catch (err) {
                                    console.error('Erro ao atualizar tabela:', err);
                                    const errorContainer = document.getElementById('error-popup-container');
                                    if (errorContainer) {
                                        errorContainer.innerHTML = '<div class="alert alert-danger alert-dismissible fade show" role="alert">Falha ao atualizar filtros. Tente novamente.<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>';
                                    }
                                }
                            }

                            rebindTableEvents(produtosTableWrapper);

                            filterForm.addEventListener('submit', function (e) {
                                e.preventDefault();
                                const formData = new FormData(filterForm);
                                const params = new URLSearchParams(formData);

                                params.set('page', '1');

                                const url = filterForm.action + '?' + params.toString();
                                updateTable(url);
                            });

                            produtosTableWrapper.addEventListener('click', (e) => {
                                const a = e.target.closest('.pagination a');
                                if (!a || a.href.includes('javascript:')) return;

                                e.preventDefault();
                                updateTable(a.href);
                            });

                            let searchTimer;
                            searchInput.addEventListener('input', () => {
                                clearTimeout(searchTimer);
                                searchTimer = setTimeout(() => {
                                    filterForm.querySelector('input[name="page"]').value = '1';
                                    filterForm.requestSubmit();
                                }, 400);
                            });
                        });
                    </script>
        </body>

        </html>