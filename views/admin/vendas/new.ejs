<%- include('../../partials/header.ejs') %>
    <%- include('../../partials/navbar.ejs') %>

        <div class="container mt-4">

            <form method="POST" action="/admin/vendas/save">
                <div class="row">
                    <!-- üßæ Left Column: Sale Items -->
                    <div class="col-md-7 border rounded p-3 bg-light">
                        <h4>Itens da Venda</h4>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Produto</th>
                                    <th>Quantidade</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="itens-venda-container">

                            </tbody>
                        </table>
                        <button type="button" id="add-item-btn" class="btn btn-outline-primary">
                            <i class="bi bi-plus-circle"></i> Adicionar Produto
                        </button>
                    </div>

                    <!-- üí∞ Right Column: Price Summary -->
                    <div class="col-md-5 border rounded p-3 bg-light">
                        <h4>Resumo de Pre√ßos</h4>
                        <ul class="list-group mb-3" id="resumo-precos"></ul>
                        <div class="card">
                            <div class="card-body">
                                <h5>Total: R$ <span id="total-geral">0.00</span></h5>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-4">
                    <input type="text" id="codigo-input" class="form-control" autocomplete="off"
                        placeholder="Leia o c√≥digo de barras aqui...">
                </div><br>

                <button class="btn btn-success">
                    <i class="bi bi-check-circle"></i> Cadastrar Venda
                </button>
        </div>
        </form>
        </div>

        <%- include('../../partials/footer.ejs') %>

            <script>
                const produtos = <%- JSON.stringify(produtos) %>;
            </script>

            <script>

                document.addEventListener('DOMContentLoaded', () => {
                    const barcodeInput = document.getElementById('codigo-input');
                    const addItemBtn = document.getElementById('add-item-btn');
                    const itemsContainer = document.getElementById('itens-venda-container');
                    const resumoPrecos = document.getElementById('resumo-precos');
                    const totalGeral = document.getElementById('total-geral');
                    let itemIndex = 0;

                    barcodeInput.focus();

                    barcodeInput.addEventListener('keypress', function (e) {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            const codigo = this.value.trim();
                            if (codigo) {
                                fetch(`/admin/vendas/produtos/codigobarras/${codigo}`)
                                    .then(res => res.json())
                                    .then(produto => {
                                        if (produto && produto.id_produto) {
                                            addProductRow(produto);
                                        } else {
                                            alert('Produto n√£o encontrado!');
                                        }
                                    })
                                    .catch(err => {
                                        console.error('Erro ao buscar produto:', err);
                                    });
                                this.value = '';
                            }
                        }
                    });

                    addItemBtn.addEventListener('click', () => {
                        addProductRow(null);
                    });

                    function addProductRow(produto) {
                        const row = document.createElement('tr');
                        row.classList.add('item-row');

                        let selectHTML = '';
                        produtos.forEach(p => {
                            selectHTML += `<option value="${p.id_produto}" data-preco="${p.preco}">${p.nome}</option>`;
                        });


                        row.innerHTML = `
        <td>
          <select name="itens[${itemIndex}][id_produto]" class="form-select produto-select">
            ${selectHTML}
          </select>
        </td>
        <td>
          <input type="number" name="itens[${itemIndex}][quantidade]" class="form-control quantidade-input" value="1" min="1">
        </td>
        <td>
          <button type="button" class="btn btn-danger remove-item-btn">
            <i class="bi bi-trash"></i>
          </button>
        </td>
      `;

                        itemsContainer.appendChild(row);

                        if (produto) {
                            const select = row.querySelector('.produto-select');
                            const option = [...select.options].find(opt => opt.value == produto.id_produto);
                            if (option) {
                                option.selected = true;
                            }
                        }

                        itemIndex++;
                        updateResumo();
                    }

                    itemsContainer.addEventListener('click', (event) => {
                        if (event.target.closest('.remove-item-btn')) {
                            const row = event.target.closest('tr');
                            if (row) row.remove();
                            updateResumo();
                        }
                    });

                    function updateResumo() {
                        resumoPrecos.innerHTML = '';
                        let total = 0;

                        document.querySelectorAll('.item-row').forEach(row => {
                            const select = row.querySelector('.produto-select');
                            const input = row.querySelector('.quantidade-input');
                            const preco = parseFloat(select.selectedOptions[0].dataset.preco || 0);
                            const quantidade = parseInt(input.value || 0);
                            const subtotal = preco * quantidade;

                            if (quantidade > 0) {
                                const li = document.createElement('li');
                                li.className = 'list-group-item d-flex justify-content-between align-items-center';
                                li.innerHTML = `${select.selectedOptions[0].text} x ${quantidade} <span>R$ ${subtotal.toFixed(2)}</span>`;
                                resumoPrecos.appendChild(li);
                                total += subtotal;
                            }
                        });

                        totalGeral.textContent = total.toFixed(2);
                    }

                    itemsContainer.addEventListener('change', updateResumo);
                    itemsContainer.addEventListener('input', updateResumo);
                });

            </script>